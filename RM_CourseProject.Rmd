---
title: 'Peer-graded Assignment: Regression Models Course Project'
author: "Alejandro Osorio"
date: "June 29, 2018"
output:
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(car)
data(mtcars)
mtcars <- data.frame(mtcars)
```


## Appendix 1: Preliminary Data Analysis

Basic properties of the 'mtcars' dataset:

```{r, echo = FALSE}
str(mtcars)
```

So, we're talking of a small sample of only 32 observations.

Additionally, visual correlations among pairs of potential variables can be seen as follows:

```{r, echo = FALSE}
pairs(~ ., mtcars)
```

## Appendix 2: Model Selection

Given the nature of the analysis (continuous outcome, obtained from discrete and continuous regressors), the size of the dataset (only 32 observations), plus the visual correlations observed between 'mpg' (the outcome) and its potential regressors, the model to be used wil be linear (lm type), with 'am' as a not-so-dummy binary-factor variable.

## Appendix 3: Choosing Preliminary Regressors

A preliminary analysis considered all mtcars variables as potential regressors.  With variables 'cyl', 'vs', 'am', 'gear' and 'carb' as factors, the following lm function was analysed:

```{r, echo=FALSE}
mtcars2 <- mtcars
mtcars2$cyl <- factor(mtcars$cyl)
mtcars2$vs <- factor(mtcars$vs)
mtcars2$am <- factor(mtcars$am)
mtcars2$gear <- factor(mtcars$gear)
mtcars2$carb <- factor(mtcars$carb)
```

```{r}
fitAll <- lm(mpg ~ ., mtcars2)
summary(fitAll)$coef
```


With a P-value based criteria, no variable makes the cut (with 'hp' and 'wt' the closest, though). Therefore, the first conclusion was that some industry research was required in order to determine the best regressor candidates for 'mpg' outcome.

After some web research (such as http://www.driverside.com/auto-library/top_10_factors_contributing_to_fuel_economy-317 and https://www.quora.com/On-what-factors-does-mileage-of-a-vehicle-depend), the main variables suggested (and therefore candidates for main regresors), were: displacement ('disp'), power ('hp'), aerodynamics, weight ('wt') and number of forward gears ('gear').

Besides aerodynamics (not available in the dataset), the visual correlations between them and 'mpg' are pretty clear, as seen in Appendix 1 (such as the inverse relation between 'mpg' and  both 'hp' or 'wt' -both of which had the lowest P-values when including all variables in the model, as seen before-). Therefore, including 'am' (required in order to answer the main question), they were selected as candidates for regression modeling in the next appendix.

Finally, given the lowest P-value results obtained by 'wt' and 'hp' regressors (in comparison with the rest), plus the well known Weight/Power KPI (Key Performance Indicator) from the automotive industry, in further analysis both 'wt' and 'hp' will be considered primary potential regressors while 'disp' and 'gear' will be considered secondary potential regressors (just to prioritize further analysis. Cuantitative analysis will finally determine which regressors to keep).

## Appendix 4: Regression Modeling

For the regression analysis, two types of models were used.

The first one with different intersection points but the same slope for all regression lines (no interaction between 'am' -the binary factor regressor- and the rest of the regressors), such as:

```{r, echo=FALSE}
fit1am <- lm(mpg ~ factor(am), mtcars)
fit1disp <- lm(mpg ~ disp, mtcars)
fit1gear <- lm(mpg ~ gear, mtcars)
fit1hp <- lm(mpg ~ hp, mtcars)
fit1wt <- lm(mpg ~ wt, mtcars)
fit2disp_am <- lm(mpg ~ disp + factor(am), mtcars)
fit2gear_am <- lm(mpg ~ factor(gear) + factor(am), mtcars)
fit2hp_am <- lm(mpg ~ hp + factor(am), mtcars)
fit2wt_am <- lm(mpg ~ wt + factor(am), mtcars)
fit3wt_disp_am <- lm(mpg ~ wt + disp + factor(am), mtcars)
fit3disp_gear_am <- lm(mpg ~ disp + factor(gear) + factor(am), mtcars)
fit3gear_hp_am <- lm(mpg ~ factor(gear) + hp + factor(am), mtcars)
fit3gear_wt_am <- lm(mpg ~ factor(gear) + wt + factor(am), mtcars)
fit3hp_disp_am <- lm(mpg ~ hp + disp + factor(am), mtcars)
fit3hp_wt_am <- lm(mpg ~ hp + wt + factor(am), mtcars)
fit4wt_hp_disp_am <- lm(mpg ~ wt + hp + disp + factor(am), mtcars)
fit4wt_hp_gear_am <- lm(mpg ~ wt + hp + factor(gear) + factor(am), mtcars)
fit4wt_disp_gear_am <- lm(mpg ~ wt + disp + factor(gear) + factor(am), mtcars)
fit4hp_disp_gear_am <- lm(mpg ~ hp + disp + factor(gear) + factor(am), data = mtcars)
fit5wt_hp_disp_gear_am <- lm(mpg ~ wt + hp + disp + factor(gear) + factor(am), mtcars)
summary(fit3hp_wt_am)$call
```

The second one, with different intersects AND slopes for regression lines (factor(am):regressor type interactions), such as:

```{r, echo=FALSE}
fitint2disp_am <- lm(mpg ~ disp + factor(am) + factor(am):disp, mtcars)
fitint2gear_am <- lm(mpg ~ factor(gear) + factor(am) + factor(am):factor(gear), mtcars)
fitint2hp_am <- lm(mpg ~ hp + factor(am) + factor(am):hp, mtcars)
fitint2wt_am <- lm(mpg ~ wt + factor(am) + factor(am):wt, mtcars)
fitint3disp_gear_am <- lm(mpg ~ disp + factor(gear) + factor(am) + factor(am):disp + 
    factor(am):factor(gear), mtcars)
fitint3gear_hp_am <- lm(mpg ~ factor(gear) + hp + factor(am) + factor(am):factor(gear) + 
    factor(am):hp, mtcars)
fitint3gear_wt_am <- lm(mpg ~ factor(gear) + wt + factor(am) + factor(am):factor(gear) + 
    factor(am):wt, mtcars)
fitint3hp_disp_am <- lm(mpg ~ hp + disp + factor(am) + factor(am):hp + 
    factor(am):disp, mtcars)
fitint3hp_wt_am <- lm(mpg ~ hp + wt + factor(am) + factor(am):hp + 
    factor(am):wt, mtcars)
fitint3hp_wt_am_nointhp <- lm(mpg ~ hp + wt + factor(am) + factor(am):wt, mtcars)
fitint3wt_disp_am <- lm(mpg ~ wt + disp + factor(am) + factor(am):wt +       factor(am):disp, mtcars)
fitint4wt_hp_disp_am <- lm(mpg ~ wt + hp + disp + factor(am) + factor(am):wt + factor(am):hp + 
    factor(am):disp, mtcars)
fitint4wt_hp_gear_am <- lm(mpg ~ wt + hp + factor(gear) + factor(am) + factor(am):wt + factor(am):hp + 
    factor(am):factor(gear), mtcars)
summary(fitint3hp_wt_am)$call
```

Additionally, ANOVA comparisons (incrementally adding regressors from the preliminary set, defined in Appendix 3) were used in order to determine the best regressor mix for each model.  The order in which regressor candidates were added, followed the primary and secondary criteria specified in Appendix 3.  Therefore, the regressor sequences to be considered, were the following (all with 'am' included):

1. 'wt' - 'hp' - 'disp'
2. 'wt' - 'hp' - 'gear'
3. 'hp' - 'disp' - 'gear'
4. 'wt' - 'gear' - 'disp'

### Model 1: Different intersection points, with same slopes

```{r, echo=FALSE}
anova(fit1am, fit2wt_am, fit3hp_wt_am, fit4wt_hp_disp_am)
```

ANOVA test with 2nd sequence (replacing 'disp' by 'gear') resulted in almost same outcome.

Just in case, ANOVA analysis of the first sequence was carried on, reordering the sequence as follows: 'wt' - 'disp' - 'hp'

```{r, echo=FALSE}
anova(fit1am, fit2wt_am, fit3wt_disp_am, fit4wt_hp_disp_am)
```

Interestingly enough, the result sugests that all 4 regressors are relevant for the outcome.  Same test was carried on with the sequence number 2, with less promising results.

Sequences 3 and 4 were not relevant as soon as regressors 'disp' or 'gear' were included (including sequence reordering).

Therefore, model 4 passed the test for final P-value analysis of its coefficients, as follows:

```{r, echo=FALSE}
summary(fit4wt_hp_disp_am)$coef
```

Given the P-value > 0.05 for the 'hp:factor(am)'disp' regressor ('am' regressor is included anyway, being required as binary factor), the final model is as follows:

```{r, echo=FALSE}
model1 <- fit3hp_wt_am
summary(model1)$call
```


### Model 2: Different intersection points and slopes

ANOVA analysis to sequences 1 and 2 suggests 'wt', 'hp' and 'am' are the only relevant regressors (including 'disp' or 'gear' in any order, didn't make a difference) when including variable slopes.

```{r, echo=FALSE}
anova(fit1am, fitint2wt_am, fitint3hp_wt_am, fitint4wt_hp_gear_am)
```

Therefore, model 3 passed the test for final P-value analysis of its coefficients, as follows:

```{r, echo=FALSE}
summary(fitint3hp_wt_am)$coef
```

Given the P-value > 0.05 for the hp:factor(am) coefficient, the final model is as follows:

```{r, echo=FALSE}
model2 <- fitint3hp_wt_am_nointhp
summary(model2)$call
```

## Appendix 5: Regression Diagnostics

### Model 1: Different intersection points, with same slopes

```{r, echo=FALSE}
par(mfrow = c(2,2))
plot(model1, which = c(1,2,4,5))
```

Redisual analysis looks good enough (no visible unbalanced patterns).  Normal distribution of residuals, as well as their leverage, look a bit off though.  It probably requires further analysis of cases such as Chrysler Imperial.


### Model 2: Different intersection points and slopes

```{r, echo=FALSE}
par(mfrow = c(2,2))
plot(model2, which = c(1,2,4,5))
```

Redisual analysis looks good enough (no visible patterns).  Normal distribution of residuals, as well as their leverage, look a bit off though.  It probably requires further analysis of cases such as Masseratti Bora.

## Appendix 6: Confidence Intervals

### Model 1: Different intersection points, with same slopes

```{r, echo=FALSE}
sumCoef1 <- summary(model1)$coef
sumCoef1
```

Considering that the 4th row represents the impact on the intercept once we include the factor that the transmission is manual (without changing the slopes), the confidence interval for that impact is:

```{r}
sumCoef1[4,1] + c(-1,1) * qt(.975, df = model1$df) * sumCoef1[4,2]
```

Which means that, with a 95% confidence, we estimate that cars with a manual transmission result in a -0.74 to 4.9 general impact in MPG, compared to those with automatic transmission, at the average value of any of this model's regressors ('wt' or 'hp').

### Model 2: Different intersection points and slopes

```{r, echo=FALSE}
sumCoef2 <- summary(model2)$coef
sumCoef2
```

```{r}
sumCoef2[4,1] + c(-1,1) * qt(.975, df = model2$df) * sumCoef2[4,2]
```

In this case, with a 95% confidence, we estimate that cars with a manual transmission result in a 3.3 to 19.8 general impact in MPG, compared to those with automatic transmission, at the average value of any of this model's regressors ('wt' or 'hp').  Additionally, considering the wt:factor(am)1 interaction:

```{r}
sumCoef2[5,1] + c(-1,1) * qt(.975, df = model2$df) * sumCoef2[5,2]
```

With a 95% confidence, we also estimate that cars with a manual transmission result in an extra -6.53 to -0.618 impact in MPG for each 1000 lbs increase in weight.